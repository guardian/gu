import {
	getLocalNodeModulesLastModified,
	getStoredNodeModulesLastModified,
} from './node_modules.ts';
import { getLocalLockfileHash, getStoredLockfileHash } from './lockfile.ts';

export const shouldInstallNodeModules = async (lockfile: string) => {
	const [
		localLockfileHash,
		localNodeModulesChanged,
		storedLockfileHash,
		storedNodeModulesChanged,
	] = await Promise.all([
		getLocalLockfileHash(lockfile),
		getLocalNodeModulesLastModified(),
		getStoredLockfileHash(lockfile),
		getStoredNodeModulesLastModified(),
	]);

	if (!localNodeModulesChanged || !storedNodeModulesChanged) {
		return true;
	}

	if (
		storedLockfileHash === localLockfileHash &&
		storedNodeModulesChanged.toString() === localNodeModulesChanged.toString()
	) {
		return false;
	}

	return true;
};
